<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        
        .test-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .file-input {
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #718096;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .result {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .success {
            background: #c6f6d5;
            border-left-color: #38a169;
            color: #22543d;
        }
        
        .error {
            background: #fed7d7;
            border-left-color: #e53e3e;
            color: #742a2a;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .preview-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .preview-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .template-files {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .template-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .template-section h3 {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏</h1>
    
    <!-- –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö SVG —Ñ–∞–π–ª–æ–≤ -->
    <div class="test-section">
        <h2 class="test-title">1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö SVG —Ñ–∞–π–ª–æ–≤</h2>
        <button class="btn" onclick="createTestSVGs()">üé® –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ SVG</button>
        <div id="svg-result" class="result" style="display: none;"></div>
    </div>
    
    <!-- –¢–µ—Å—Ç 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏ —Å –ø—Ä–µ–≤—å—é -->
    <div class="test-section">
        <h2 class="test-title">2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏ —Å –ø—Ä–µ–≤—å—é</h2>
        
        <form id="carousel-form">
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–±–æ—Ä–∞</label>
                <input type="text" id="carousel-name" class="form-input" value="Test Modern Carousel" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="carousel-category" class="form-select" required>
                    <option value="open-house">Open House</option>
                    <option value="sold">Sold</option>
                    <option value="for-rent">For Rent</option>
                </select>
            </div>
            
            <div class="template-files">
                <div class="template-section">
                    <h3>üéØ Main Template</h3>
                    <div class="form-group">
                        <label class="form-label">SVG —Ñ–∞–π–ª Main</label>
                        <input type="file" id="main-svg" class="file-input" accept=".svg" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–µ–≤—å—é Main (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" id="main-preview" class="file-input" accept="image/*">
                    </div>
                </div>
                
                <div class="template-section">
                    <h3>üì∏ Photo Template</h3>
                    <div class="form-group">
                        <label class="form-label">SVG —Ñ–∞–π–ª Photo</label>
                        <input type="file" id="photo-svg" class="file-input" accept=".svg" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–µ–≤—å—é Photo (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" id="photo-preview" class="file-input" accept="image/*">
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn">üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—É—Å–µ–ª—å</button>
            <button type="button" class="btn btn-secondary" onclick="uploadWithTestFiles()">üß™ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏</button>
        </form>
        
        <div id="upload-result" class="result" style="display: none;"></div>
    </div>
    
    <!-- –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div class="test-section">
        <h2 class="test-title">3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏</h2>
        <button class="btn" onclick="checkCarousels()">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—Ä—É—Å–µ–ª–∏</button>
        <button class="btn btn-secondary" onclick="checkPreviews()">üñºÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
        <div id="check-result" class="result" style="display: none;"></div>
    </div>

    <script>
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö SVG —Ñ–∞–π–ª–æ–≤
        function createTestSVGs() {
            const mainSVG = `<svg width="1080" height="1080" xmlns="http://www.w3.org/2000/svg">
                <rect width="1080" height="1080" fill="#667eea"/>
                <text x="540" y="300" text-anchor="middle" fill="white" font-size="48" font-weight="bold">MAIN TEMPLATE</text>
                <text x="540" y="400" text-anchor="middle" fill="white" font-size="32">{{property_address}}</text>
                <text x="540" y="500" text-anchor="middle" fill="white" font-size="28">{{property_price}}</text>
                <text x="540" y="600" text-anchor="middle" fill="white" font-size="24">{{agent_name}}</text>
                <text x="540" y="700" text-anchor="middle" fill="white" font-size="20">{{agent_phone}}</text>
            </svg>`;
            
            const photoSVG = `<svg width="1080" height="1080" xmlns="http://www.w3.org/2000/svg">
                <rect width="1080" height="1080" fill="#764ba2"/>
                <rect x="90" y="90" width="900" height="600" fill="#f0f0f0" stroke="#333" stroke-width="2"/>
                <text x="540" y="750" text-anchor="middle" fill="white" font-size="32">{{property_address}}</text>
                <text x="540" y="800" text-anchor="middle" fill="white" font-size="24">{{agent_name}}</text>
                <text x="540" y="850" text-anchor="middle" fill="white" font-size="20">{{agent_phone}}</text>
                <text x="540" y="400" text-anchor="middle" fill="#666" font-size="24">PHOTO TEMPLATE</text>
            </svg>`;
            
            // –°–æ–∑–¥–∞–µ–º Blob —Ñ–∞–π–ª—ã
            window.testMainSVG = new Blob([mainSVG], { type: 'image/svg+xml' });
            window.testPhotoSVG = new Blob([photoSVG], { type: 'image/svg+xml' });
            
            document.getElementById('svg-result').innerHTML = `
                <div class="success">
                    ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ SVG —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:<br>
                    ‚Ä¢ Main Template: ${mainSVG.length} —Å–∏–º–≤–æ–ª–æ–≤<br>
                    ‚Ä¢ Photo Template: ${photoSVG.length} —Å–∏–º–≤–æ–ª–æ–≤<br>
                    ‚Ä¢ –û–±–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç dyno –ø–æ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                </div>
            `;
            document.getElementById('svg-result').style.display = 'block';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
        function uploadWithTestFiles() {
            if (!window.testMainSVG || !window.testPhotoSVG) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ SVG —Ñ–∞–π–ª—ã!');
                return;
            }
            
            const formData = new FormData();
            formData.append('name', document.getElementById('carousel-name').value);
            formData.append('category', document.getElementById('carousel-category').value);
            formData.append('main_file', window.testMainSVG, 'test-main.svg');
            formData.append('photo_file', window.testPhotoSVG, 'test-photo.svg');
            
            uploadCarousel(formData);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('carousel-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('carousel-name').value);
            formData.append('category', document.getElementById('carousel-category').value);
            
            const mainSVG = document.getElementById('main-svg').files[0];
            const photoSVG = document.getElementById('photo-svg').files[0];
            const mainPreview = document.getElementById('main-preview').files[0];
            const photoPreview = document.getElementById('photo-preview').files[0];
            
            if (!mainSVG || !photoSVG) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ SVG —Ñ–∞–π–ª–∞!');
                return;
            }
            
            formData.append('main_file', mainSVG);
            formData.append('photo_file', photoSVG);
            
            if (mainPreview) {
                formData.append('main_preview_file', mainPreview);
            }
            
            if (photoPreview) {
                formData.append('photo_preview_file', photoPreview);
            }
            
            uploadCarousel(formData);
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏
        function uploadCarousel(formData) {
            const resultDiv = document.getElementById('upload-result');
            resultDiv.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å...';
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            
            fetch('/api/upload-carousel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `<div class="success">
                        ‚úÖ –ö–∞—Ä—É—Å–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!<br>
                        <strong>ID –∫–∞—Ä—É—Å–µ–ª–∏:</strong> ${data.carousel_id}<br>
                        <strong>Main Template ID:</strong> ${data.main_template_id}<br>
                        <strong>Photo Template ID:</strong> ${data.photo_template_id}<br>
                        <strong>Main dyno –ø–æ–ª—è:</strong> ${data.main_dyno_fields.join(', ') || '–Ω–µ—Ç'}<br>
                        <strong>Photo dyno –ø–æ–ª—è:</strong> ${data.photo_dyno_fields.join(', ') || '–Ω–µ—Ç'}<br>
                    `;
                    
                    if (data.main_preview_url) {
                        html += `<strong>Main –ø—Ä–µ–≤—å—é:</strong> <a href="${data.main_preview_url}" target="_blank">${data.main_preview_url}</a><br>`;
                    }
                    
                    if (data.photo_preview_url) {
                        html += `<strong>Photo –ø—Ä–µ–≤—å—é:</strong> <a href="${data.photo_preview_url}" target="_blank">${data.photo_preview_url}</a><br>`;
                    }
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏
        function checkCarousels() {
            const resultDiv = document.getElementById('check-result');
            resultDiv.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—É—Å–µ–ª–∏...';
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            
            fetch('/api/carousels')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.carousels.length > 0) {
                    let html = '<div class="success">‚úÖ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏:<br>';
                    data.carousels.forEach(carousel => {
                        html += `
                            <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 4px;">
                                <strong>${carousel.name}</strong> (${carousel.category})<br>
                                ID: ${carousel.id}<br>
                                Main Template: ${carousel.main_template_id}<br>
                                Photo Template: ${carousel.photo_template_id}
                            </div>
                        `;
                    });
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå –ö–∞—Ä—É—Å–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–≤—å—é
        function checkPreviews() {
            const resultDiv = document.getElementById('check-result');
            resultDiv.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–≤—å—é...';
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            
            fetch('/api/templates')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.templates.length > 0) {
                    let html = '<div class="success">‚úÖ –®–∞–±–ª–æ–Ω—ã —Å –ø—Ä–µ–≤—å—é:<br><div class="preview-grid">';
                    
                    data.templates.forEach(template => {
                        const previewUrl = `/api/template-preview/${template.id}`;
                        html += `
                            <div class="preview-item">
                                <strong>${template.name}</strong><br>
                                <small>–†–æ–ª—å: ${template.template_role || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</small><br>
                                <img src="${previewUrl}" class="preview-image" alt="Preview" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZmFmYyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNzE4MDk2Ij5ObyBQcmV2aWV3PC90ZXh0Pjwvc3ZnPg=='">
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå –®–∞–±–ª–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            });
        }
    </script>
</body>
</html>